<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ó–∞—Ä–ø–ª–∞—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{ --accent:#00796b; --accent-dark:#004d40; --card-bg: rgba(255,255,255,0.78); --card-shadow: 0 12px 30px rgba(6,22,37,0.12); }
html,body{ height:100%; }
body{ font-family:'Inter',sans-serif; margin:0; padding:0; min-height:100vh; position:relative; overflow-x:hidden; background:linear-gradient(120deg,#f0fbff 0%,#f6fff7 40%,#fffaf0 100%); color:#04363a; }
body::before, body::after{ content:""; position:fixed; pointer-events:none; z-index:0; filter: blur(90px); opacity:0.55; }
body::before{ width:640px; height:640px; left:-8%; top:-10%; background: radial-gradient(circle at 30% 30%, rgba(0,121,107,0.14), rgba(0,121,107,0.06) 30%, transparent 60%); transform: rotate(-10deg); }
body::after{ width:520px; height:520px; right:-6%; bottom:-6%; background: radial-gradient(circle at 70% 70%, rgba(1,87,155,0.10), rgba(1,87,155,0.04) 30%, transparent 60%); transform: rotate(20deg); }
#main{ max-width:640px; margin:80px auto; text-align:center; padding:34px; background:var(--card-bg); border-radius:20px; box-shadow:var(--card-shadow); z-index:1; }
#sidebar{ position:fixed; top:20px; right:20px; width:260px; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.70)); padding:16px 22px; border-radius:14px; box-shadow:0 12px 30px rgba(6,22,37,0.08); z-index:2; }
#sidebar h4{ margin:0; color:var(--accent); cursor:pointer; user-select:none; }
#authForm{ margin-top:10px; max-height:0; opacity:0; transition:max-height 0.28s ease, opacity 0.28s ease; overflow:hidden; }
#authForm.show{ max-height:220px; opacity:1; }
input,button{ padding:9px; margin:8px 0; width:100%; box-sizing:border-box; border-radius:10px; border:1px solid #dbe9e6; font-size:0.96em; }
button{ background:var(--accent); color:#fff; border:none; cursor:pointer; transition:0.18s; }
button:hover{ background:var(--accent-dark); }
button:disabled{ background:#bbb; cursor:not-allowed; }
#authStatus{ font-size:0.86em; color:#375651; margin-top:6px; }
#balanceDisplay{ font-size:2.6em; margin-bottom:14px; font-weight:600; letter-spacing:0.4px; }
#manualAmount,#addBtn{ margin-top:14px; font-size:1em; }
#addBtn{ display:flex; align-items:center; justify-content:center; gap:8px; }
#historyContainer{ margin-top:34px; text-align:left; max-height:340px; overflow-y:auto; }
.history-item{ padding:10px; margin:6px 0; background:rgba(255,255,255,0.85); border-radius:10px; box-shadow:0 4px 10px rgba(6,22,37,0.06); display:flex; justify-content:space-between; align-items:center; }
@media (max-width:700px){ #main{ margin:60px 18px; padding:22px; } #sidebar{ width:calc(100% - 40px); right:20px; left:20px; top:auto; bottom:20px; } }
</style>
</head>
<body>

<div id="sidebar">
  <h4 id="toggleAuth">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
  <div id="authForm">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
    <p id="authStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
  </div>
</div>

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn"><span>üí∞</span> –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>

  <div id="historyContainer">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
    <div id="historyList">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  </div>
</div>

<script type="module">
function showToast(text, timeout = 3500){
  let t = document.getElementById('__app_toast__');
  if(!t){
    t = document.createElement('div'); t.id='__app_toast__';
    Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'rgba(6,22,37,0.9)',color:'#fff',padding:'10px 16px',borderRadius:'10px',zIndex:99999,fontFamily:'Inter, sans-serif',fontSize:'14px'});
    document.body.appendChild(t);
  }
  t.textContent = text;
  t.style.opacity = '1';
  clearTimeout(t.__hideTimer);
  t.__hideTimer = setTimeout(()=> t.style.opacity='0', timeout);
}

// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

// –¢–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
const firebaseConfig = {
  apiKey: "AIzaSyDNk1We9du5BJyrgGbQrkqd7tSDscneIOA",
  authDomain: "gold-11fa4.firebaseapp.com",
  databaseURL: "https://gold-11fa4-default-rtdb.firebaseio.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.firebasestorage.app",
  messagingSenderId: "226774330161",
  appId: "1:226774330161:web:d1e1c93ade5dcea31d5e10",
  measurementId: "G-7MLLBN1YZ4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Elements
const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");
const historyList = document.getElementById("historyList");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtnEl = document.getElementById("loginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const toggleAuth = document.getElementById("toggleAuth");
const authForm = document.getElementById("authForm");

let rate = 15000;
let lastBalance = 176000;

// Firestore refs
const balanceDocRef = doc(db,"salaryData","balance");
const entriesColRef = collection(balanceDocRef, "entries");

// UI helpers
function enableEditing(enabled){ manualAmount.disabled = !enabled; addBtn.disabled = !enabled; }
function animateBalanceChange(newBalance, prevBalance, changeAmount = 0){
  const from = Number(prevBalance)||0; const to = Number(newBalance)||0;
  balanceDisplay.style.color = (to - from >= 0) ? "#2e7d32" : "#c62828";
  balanceDisplay.textContent = Math.round(to).toLocaleString('ru-RU');
  if(changeAmount !== 0){
    const anim = document.createElement("div"); anim.textContent = (changeAmount>0?"+":"-")+Math.abs(changeAmount).toLocaleString('ru-RU');
    Object.assign(anim.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'rgba(0,0,0,0.7)',color:'#fff',padding:'6px 10px',borderRadius:'8px',zIndex:99999});
    document.body.appendChild(anim); setTimeout(()=>anim.remove(),1200);
  }
}

// –ò—Å—Ç–æ—Ä–∏—è
async function updateHistory(){
  try{
    const q = query(entriesColRef, orderBy("date","desc"));
    const snap = await getDocs(q);
    if(snap.empty){ historyList.innerHTML = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; return; }
    historyList.innerHTML = "";
    snap.forEach(d=>{
      const data = d.data();
      let dateStr = data.date && typeof data.date.toDate==="function"? data.date.toDate().toLocaleString(): new Date(data.date).toLocaleString();
      const amount = (typeof data.amount==="number")? data.amount.toLocaleString('ru-RU'): String(data.amount);
      const sign = (data.amount >= 0) ? "+" : "-";
      const div = document.createElement("div"); div.className = "history-item";
      div.innerHTML = `<div class="history-date">${dateStr}</div><div style="color:${data.amount>=0?"#2e7d32":"#c62828"}">${sign}${amount}</div>`;
      historyList.appendChild(div);
    });
  }catch(e){ console.warn(e); historyList.innerHTML="–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
async function commitBalanceChange(amount){
  if(!auth.currentUser){ showToast('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'); return lastBalance+amount; }
  let newBalance = lastBalance + Number(amount);
  try{
    const batch = writeBatch(db);
    batch.set(balanceDocRef,{ balance:newBalance },{ merge:true });
    const newEntryRef = doc(entriesColRef);
    batch.set(newEntryRef,{ date:serverTimestamp(), amount:Number(amount) });
    await batch.commit();
  }catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏'); }
  return newBalance;
}

// –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–≤—ã—á–∏—Ç–∞–Ω–∏—è
addBtn.onclick = async ()=>{
  let value = parseFloat(manualAmount.value);
  if(isNaN(value)){ showToast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!'); return; }
  addBtn.disabled = true;
  const newBalance = await commitBalanceChange(value);
  animateBalanceChange(newBalance,lastBalance,value);
  lastBalance = newBalance;
  manualAmount.value="";
  updateHistory();
  addBtn.disabled = false;
};

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
toggleAuth.onclick = ()=> authForm.classList.toggle("show");
loginBtnEl.onclick = async ()=> {
  try{ await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }
  catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e.message || e)); }
};
logoutBtnEl.onclick = async ()=> {
  try{ await signOut(auth); showToast('–í—ã –≤—ã—à–ª–∏'); }
  catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞'); }
};
function updateAuthUI(user){
  if(user){
    authStatus.textContent = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ " + user.email;
    loginBtnEl.style.display="none"; logoutBtnEl.style.display="inline-block";
    emailInput.style.display=passwordInput.style.display="none";
    toggleAuth.textContent="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    enableEditing(true);
  }else{
    authStatus.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtnEl.style.display="inline-block"; logoutBtnEl.style.display="none";
    emailInput.style.display=passwordInput.style.display="inline-block";
    toggleAuth.textContent="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è";
    enableEditing(false);
  }
}
onAuthStateChanged(auth, updateAuthUI);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞
async function initBalance(){
  const snap = await getDoc(balanceDocRef);
  if(snap.exists() && typeof snap.data().balance==="number") lastBalance=snap.data().balance;
  else await setDoc(balanceDocRef,{ balance:lastBalance },{ merge:true });
  balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
  updateHistory();
}
initBalance();

// –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
async function addDailyRate(days=1){
  const amount = rate*days;
  const newBalance = await commitBalanceChange(amount);
  animateBalanceChange(newBalance,lastBalance,amount);
  lastBalance=newBalance;
  updateHistory();
}
(function setupDailyChecker(){
  const KEY='last_daily_date';
  const todayStr=new Date().toISOString().split("T")[0];
  let lastDate = localStorage.getItem(KEY) || todayStr;
  let diff = Math.floor((new Date(todayStr)-new Date(lastDate))/(1000*60*60*24));
  if(diff>1) addDailyRate(diff-1); // –Ω–∞—á–∏—Å–ª—è–µ–º –∑–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–Ω–∏
  localStorage.setItem(KEY,todayStr);
  setInterval(async ()=>{
    const nowStr = new Date().toISOString().split("T")[0];
    const stored = localStorage.getItem(KEY) || nowStr;
    if(stored!==nowStr){ await addDailyRate(1); localStorage.setItem(KEY,nowStr); }
  },60*1000);
})();

document.addEventListener('click', (e)=>{
  if(!document.getElementById('sidebar').contains(e.target)) authForm.classList.remove('show');
});
</script>
</body>
</html>