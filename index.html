<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–£—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã</title>
<style>
body { font-family: Arial; max-width: 600px; margin: 40px auto; padding: 20px; background:#f4f6f8; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
input, button { padding:5px; margin:5px 0; width:100%; box-sizing:border-box;}
button:disabled { background:#999; cursor:not-allowed;}
#auth-section { text-align:center; margin-bottom:20px;}
</style>
</head>
<body>
<h2>üìÖ –£—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã</h2>

<div id="auth-section">
  <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button id="loginBtn">–í–æ–π—Ç–∏</button>
  <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
  <p id="authStatus"></p>
</div>

<h3>–ë–∞–ª–∞–Ω—Å: <span id="balanceDisplay">0</span> —Ç–µ–Ω–≥–µ</h3>
<button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

// === Firebase config ===
const firebaseConfig = {
  apiKey: "AIzaSyDNk1We9du5BJyrgGbQrkqd7tSDscneIOA",
  authDomain: "gold-11fa4.firebaseapp.com",
  databaseURL: "https://gold-11fa4-default-rtdb.firebaseio.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.firebasestorage.app",
  messagingSenderId: "226774330161",
  appId: "1:226774330161:web:d1e1c93ade5dcea31d5e10",
  measurementId: "G-7MLLBN1YZ4"
};

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const balanceDisplay = document.getElementById("balanceDisplay");
const saveBtn = document.getElementById("saveBtn");

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
let rate = 15000; // —Å—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å
let holidays = ["2025-01-01","2025-03-08","2025-03-21","2025-03-22","2025-03-23","2025-05-01","2025-05-07","2025-05-09","2025-07-06","2025-08-30","2025-12-16","2025-12-17"];
let today = new Date().toISOString().split("T")[0];

// === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");

loginBtn.onclick = async () => {
  try { await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); }
  catch(e){ alert("–û—à–∏–±–∫–∞: "+e.message);}
};
logoutBtn.onclick = async()=>{await signOut(auth);}

onAuthStateChanged(auth,user=>{
  if(user){
    authStatus.textContent="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+user.email;
    loginBtn.style.display="none"; logoutBtn.style.display="inline-block";
    emailInput.style.display=passwordInput.style.display="none";
    enableEditing(true);
  } else {
    authStatus.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtn.style.display="inline-block"; logoutBtn.style.display="none";
    emailInput.style.display=passwordInput.style.display="inline-block";
    enableEditing(false);
  }
});

function enableEditing(enabled){
  const inputs=document.querySelectorAll("input,button");
  inputs.forEach(el=>{ if(el.id!=="loginBtn" && el.id!=="logoutBtn" && el.id!=="email" && el.id!=="password"){el.disabled=!enabled}});
}

// === Firestore doc ===
const docRef = doc(db,"salaryData","balance");

// –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
onSnapshot(docRef,(docSnap)=>{
  if(docSnap.exists()){
    balanceDisplay.textContent = docSnap.data().balance.toLocaleString('ru-RU');
  } else {
    setDoc(docRef,{balance:161000}); // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—É–º–º–∞
  }
});

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä—É—á–Ω—É—é
saveBtn.onclick = async ()=>{
  const docSnap = await getDoc(docRef);
  let currentBalance = docSnap.exists()?docSnap.data().balance:161000;
  await setDoc(docRef,{balance:currentBalance});
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
};

// === –ê–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 22:00 ===
function scheduleDailyAddition(){
  const now = new Date();
  const next22 = new Date();
  next22.setHours(22,0,0,0);
  if(now>next22) next22.setDate(next22.getDate()+1);
  const msUntil22 = next22 - now;
  setTimeout(async ()=>{
    await addDailyRate();
    scheduleDailyAddition(); // —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
  }, msUntil22);
}

async function addDailyRate(){
  const docSnap = await getDoc(docRef);
  let currentBalance = docSnap.exists()?docSnap.data().balance:161000;
  let todayStr = new Date().toISOString().split("T")[0];
  let todayRate = holidays.includes(todayStr)?20000:rate;
  currentBalance += todayRate;
  await setDoc(docRef,{balance:currentBalance});
}

// –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
scheduleDailyAddition();
</script>
</body>
</html>
