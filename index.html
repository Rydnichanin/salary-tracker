<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó–∞—Ä–ø–ª–∞—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f4f8;
  min-height: 100vh;
}
#sidebar {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 220px;
  background: #ffffff;
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
#sidebar h4 { margin:0 0 10px; color:#00796b; }
input, button {
  padding:8px;
  margin:6px 0;
  width:100%;
  box-sizing:border-box;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:0.95em;
}
button {
  background:#00796b;
  color:#fff;
  border:none;
  cursor:pointer;
  transition:0.2s;
}
button:hover { background:#004d40; }
button:disabled { background:#bbb; cursor:not-allowed; }
#authStatus { font-size:0.85em; color:#555; margin-top:5px;}
#main {
  max-width: 600px;
  margin: 80px auto;
  text-align: center;
  padding: 30px;
  background: #e3f2fd;
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  color: #004d40;
}
#balanceDisplay {
  font-size:2.5em;
  margin-bottom:15px;
}
#manualAmount, #addBtn { margin-top:15px; font-size:1em; }
#addBtn { display:flex; align-items:center; justify-content:center; gap:5px; }
#addBtn span { font-weight:bold; font-size:1.1em; }
#chartContainer { margin-top:30px; }
</style>
</head>
<body>

<div id="sidebar">
  <h4>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button id="loginBtn">–í–æ–π—Ç–∏</button>
  <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
  <p id="authStatus"></p>
</div>

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn"><span>üí∞</span> –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>

  <div id="chartContainer">
    <canvas id="balanceChart" height="200"></canvas>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNk1We9du5BJyrgGbQrkqd7tSDscneIOA",
  authDomain: "gold-11fa4.firebaseapp.com",
  databaseURL: "https://gold-11fa4-default-rtdb.firebaseio.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.firebasestorage.app",
  messagingSenderId: "226774330161",
  appId: "1:226774330161:web:d1e1c93ade5dcea31d5e10",
  measurementId: "G-7MLLBN1YZ4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");

let rate = 15000;
let holidays = ["2025-01-01","2025-03-08","2025-03-21","2025-03-22","2025-03-23","2025-05-01","2025-05-07","2025-05-09","2025-07-06","2025-08-30","2025-12-16","2025-12-17"];

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtnEl = document.getElementById("loginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");

loginBtnEl.onclick = async () => {
  try { await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); }
  catch(e){ alert("–û—à–∏–±–∫–∞: "+e.message);}
};
logoutBtnEl.onclick = async()=>{await signOut(auth);}

onAuthStateChanged(auth,user=>{
  if(user){
    authStatus.textContent="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+user.email;
    loginBtnEl.style.display="none"; logoutBtnEl.style.display="inline-block";
    emailInput.style.display=passwordInput.style.display="none";
    enableEditing(true);
  } else {
    authStatus.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtnEl.style.display="inline-block"; logoutBtnEl.style.display="none";
    emailInput.style.display=passwordInput.style.display="inline-block";
    enableEditing(false);
  }
});

function enableEditing(enabled){
  manualAmount.disabled = !enabled;
  addBtn.disabled = !enabled;
}

const balanceDocRef = doc(db,"salaryData","balance");
const changesColRef = collection(db,"salaryData","changes","entries");

let lastBalance = 161000;

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ---
const ctx = document.getElementById('balanceChart').getContext('2d');
let chart = new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:'–ò–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞',data:[],borderColor:'#1976d2',backgroundColor:'rgba(25,118,210,0.2)',fill:true,tension:0.3}]},
    options:{responsive:true}
});

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ ---
async function updateChart(){
    const q = query(changesColRef, orderBy("date"));
    const snapshot = await getDocs(q);
    const labels = [];
    const data = [];
    snapshot.forEach(doc=>{
        let d = new Date(doc.data().date);
        labels.push(d.toLocaleDateString());
        data.push(doc.data().amount);
    });
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
}

// --- –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ ---
function animateBalanceChange(newBalance, prevBalance){
  let steps = 20;
  let step = 0;
  let interval = setInterval(()=>{
    step++;
    let val = prevBalance + ((newBalance - prevBalance)/steps)*step;
    balanceDisplay.textContent = Math.round(val).toLocaleString('ru-RU');
    if(step>=steps) clearInterval(interval);
  },20);
  balanceDisplay.style.color = (newBalance-prevBalance>=0)?"#2e7d32":"#c62828";
}

// --- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å ---
onSnapshot(balanceDocRef,(docSnap)=>{
  if(docSnap.exists()){
    let newBalance = docSnap.data().balance;
    animateBalanceChange(newBalance,lastBalance);
    lastBalance = newBalance;
  } else {
    setDoc(balanceDocRef,{balance:lastBalance});
  }
  updateChart();
});

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é ---
addBtn.onclick = async ()=>{
  let value = parseFloat(manualAmount.value);
  if(isNaN(value)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!");
  const docSnap = await getDoc(balanceDocRef);
  let currentBalance = docSnap.exists()?docSnap.data().balance:lastBalance;
  currentBalance += value;
  await setDoc(balanceDocRef,{balance:currentBalance});
  await addDoc(changesColRef,{date:new Date().toISOString(),amount:value});
  manualAmount.value = "";
  updateChart();
}

// --- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ ---
function scheduleDailyAddition(){
  const now = new Date();
  const next22 = new Date();
  next22.setHours(22,0,0,0);
  if(now>next22) next22.setDate(next22.getDate()+1);
  const msUntil22 = next22 - now;
  setTimeout(async ()=>{
    await addDailyRate();
    scheduleDailyAddition();
  }, msUntil22);
}

async function addDailyRate(){
  const docSnap = await getDoc(balanceDocRef);
  let currentBalance = docSnap.exists()?docSnap.data().balance:lastBalance;
  let todayStr = new Date().toISOString().split("T")[0];
  let todayRate = holidays.includes(todayStr)?20000:rate;
  currentBalance += todayRate;
  await setDoc(balanceDocRef,{balance:currentBalance});
  await addDoc(changesColRef,{date:new Date().toISOString(),amount:todayRate});
  updateChart();
}

scheduleDailyAddition();
</script>
</body>
</html>
