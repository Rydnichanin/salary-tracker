<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Автоподсчёт зарплаты</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; }
input, button { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
#history { margin-top: 20px; }
.history-item { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; gap: 8px; }
.history-left { flex: 1; }
.history-actions { display: flex; gap: 6px; }
.small-btn { padding: 4px 8px; width: auto; }
canvas { margin-top: 20px; max-width: 100%; }
#userStatus { font-size: 0.9rem; color: #555; margin-bottom: 8px; }
</style>
</head>
<body>

<h2>Учёт зарплаты</h2>

<div id="userStatus">Подключение к Firebase...</div>

<label>Дата транзакции:</label>
<input type="date" id="transDate">

<label>Сумма (положительное число — аванс, отрицательное — выплата):</label>
<input type="number" id="change">

<div style="display:flex; gap:8px;">
  <button id="saveBtn" onclick="addOrSaveTransaction()">Добавить транзакцию</button>
  <button id="cancelBtn" onclick="cancelEdit()" style="display:none; width: 150px;">Отменить</button>
</div>

<div id="history"></div>
<div id="result"></div>

<canvas id="salaryChart" width="700" height="300"></canvas>

<script type="module">
import { initFirebase, auth, db, signInAnonymouslyIfNeeded } from './src/firebase.js';
import {
  collection,
  query,
  where,
  onSnapshot,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  orderBy
} from 'https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js';

await initFirebase(); // инициализация SDK (конфиг в src/firebase.js)

// --- Переменные ---
let rate = 15000;
let startDate = new Date("2025-10-23");

let transactions = []; // массив {id, date, amount}
let editingId = null;   // id документа в Firestore, который редактируется

const userStatusEl = document.getElementById('userStatus');
const historyEl = document.getElementById('history');
const resultEl = document.getElementById('result');

// --- Подключаемся к аутентификации, затем подписываемся на транзакции пользователя ---
let unsubscribeSnapshot = null;

auth.onAuthStateChanged(async (user) => {
  if (!user) {
    userStatusEl.textContent = 'Вход анонимно...';
    await signInAnonymouslyIfNeeded();
    return;
  }
  userStatusEl.textContent = `Подключён: ${user.uid}`;
  // Отписка от прежней подписки (если была)
  if (unsubscribeSnapshot) unsubscribeSnapshot();

  // Коллекция: "transactions", поле userId для доступа
  const q = query(collection(db, 'transactions'), where('userId', '==', user.uid), orderBy('date'));
  unsubscribeSnapshot = onSnapshot(q, (snap) => {
    transactions = snap.docs.map(d => ({ id: d.id, ...(d.data()) }));
    // Firestore хранит дату как строку или timestamp; привожу к ожидаемой форме
    transactions = transactions.map(t => {
      const dateStr = t.date?.toString ? t.date.toString() : t.date;
      return { id: t.id, date: dateStr, amount: Number(t.amount) };
    });
    updateDisplay();
  }, (err) => {
    console.error('Ошибка подписки на транзакции:', err);
    userStatusEl.textContent = 'Ошибка при получении данных.';
  });
});

// ----- Подсчёт баланса по дням -----
function calculateBalance() {
    let today = new Date();
    let daysWorked = Math.floor((today - startDate)/(1000*60*60*24)) + 1;
    if (daysWorked < 1) daysWorked = 1;
    let balanceByDay = [];
    let total = 0;

    for (let i=0; i<daysWorked; i++) {
        total += rate;
        let currentDate = new Date(startDate);
        currentDate.setDate(currentDate.getDate() + i);
        transactions.forEach(t => {
            let tDate = new Date(t.date);
            if (tDate.toDateString() === currentDate.toDateString()) total -= t.amount;
        });
        balanceByDay.push({date: new Date(currentDate), balance: total});
    }
    return balanceByDay;
}

// ----- Добавление или сохранение транзакции (редактирование) -----
async function addOrSaveTransaction() {
    let dateInput = document.getElementById('transDate').value;
    let amount = parseFloat(document.getElementById('change').value);
    if (!dateInput || isNaN(amount)) return alert("Заполните дату и сумму.");

    const user = auth.currentUser;
    if (!user) return alert('Пользователь не авторизован.');

    try {
      if (editingId) {
        const ref = doc(db, 'transactions', editingId);
        await updateDoc(ref, { date: dateInput, amount: amount });
        editingId = null;
      } else {
        await addDoc(collection(db, 'transactions'), {
          userId: user.uid,
          date: dateInput,
          amount: amount,
          createdAt: new Date().toISOString()
        });
      }
      clearForm();
    } catch (e) {
      console.error('Ошибка записи в Firestore:', e);
      alert('Ошибка при сохранении транзакции.');
    }
}

// ----- Начать редактирование записи -----
function startEdit(id) {
    const t = transactions.find(x => x.id === id);
    if (!t) return;
    document.getElementById('transDate').value = t.date;
    document.getElementById('change').value = t.amount;
    editingId = id;
    document.getElementById('saveBtn').textContent = "Сохранить изменение";
    document.getElementById('cancelBtn').style.display = "inline-block";
}

// ----- Отмена редактирования -----
function cancelEdit() {
    editingId = null;
    clearForm();
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Удаление транзакции -----
async function deleteTransaction(id) {
    if (!confirm("Удалить эту транзакцию?")) return;
    try {
      await deleteDoc(doc(db, 'transactions', id));
      if (editingId === id) cancelEdit();
    } catch (e) {
      console.error('Ошибка удаления:', e);
      alert('Не удалось удалить транзакцию.');
    }
}

// ----- Очистка полей формы -----
function clearForm() {
    document.getElementById('transDate').value = "";
    document.getElementById('change').value = "";
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Отображение истории и баланса -----
function updateDisplay() {
    // История транзакций
    let historyHTML = "<h3>История транзакций:</h3>";
    if (transactions.length === 0) {
        historyHTML += "<div>Транзакций нет</div>";
    } else {
        transactions.forEach((t)=>{
            const sign = t.amount > 0 ? '+' : '-';
            const abs = Math.abs(t.amount).toLocaleString('ru-RU');
            historyHTML += `<div class="history-item">
                <div class="history-left">${t.date}: ${sign}${abs}</div>
                <div class="history-actions">
                  <button class="small-btn" onclick="startEdit('${t.id}')">Редактировать</button>
                  <button class="small-btn" onclick="deleteTransaction('${t.id}')">Удалить</button>
                </div>
            </div>`;
        });
    }
    historyEl.innerHTML = historyHTML;

    // Баланс
    let balanceByDay = calculateBalance();
    let totalBalance = balanceByDay[balanceByDay.length-1]?.balance || 0;
    resultEl.innerHTML = `<h3>Итог: ${totalBalance.toLocaleString('ru-RU')} тенге</h3>`;

    // График
    drawChart(balanceByDay);
}

// ----- Построение графика -----
function drawChart(balanceByDay) {
    const ctx = document.getElementById('salaryChart').getContext('2d');
    if (window.salaryChartInstance) window.salaryChartInstance.destroy();
    window.salaryChartInstance = new Chart(ctx, { 
        type:'line',
        data:{
            labels: balanceByDay.map(b=>b.date.toISOString().split('T')[0]),
            datasets:[{
                label:'Баланс',
                data: balanceByDay.map(b=>b.balance),
                borderColor:'green',
                fill:false,
                tension:0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ----- Инициализация (обновление будет выполняться через onSnapshot) -----
updateDisplay();

// Экспортим функции в глобальную область, чтобы кнопки могли их вызывать
window.addOrSaveTransaction = addOrSaveTransaction;
window.cancelEdit = cancelEdit;
window.startEdit = startEdit;
window.deleteTransaction = deleteTransaction;
</script>
</body>
</html>