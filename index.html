<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó–∞—Ä–ø–ª–∞—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f0f4f8; min-height:100vh; }
#sidebar { position:fixed; top:20px; right:20px; width:220px; background:#ffffff; padding:15px 20px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.15); transition:all 0.4s; overflow:hidden; }
#sidebar h4 { margin:0; color:#00796b; cursor:pointer; user-select:none; }
#authForm { margin-top:10px; max-height:0; opacity:0; transition:max-height 0.4s ease, opacity 0.4s ease; overflow:hidden; }
#authForm.show { max-height:200px; opacity:1; }
input, button { padding:8px; margin:6px 0; width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #ccc; font-size:0.95em; }
button { background:#00796b; color:#fff; border:none; cursor:pointer; transition:0.2s; }
button:hover { background:#004d40; }
button:disabled { background:#bbb; cursor:not-allowed; }
#authStatus { font-size:0.85em; color:#555; margin-top:5px;}
#main { max-width:600px; margin:80px auto; text-align:center; padding:30px; background:#e3f2fd; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.15); color:#004d40; position:relative; }
#balanceDisplay { font-size:2.5em; margin-bottom:15px; }
#manualAmount, #addBtn { margin-top:15px; font-size:1em; }
#addBtn { display:flex; align-items:center; justify-content:center; gap:5px; }
#addBtn span { font-weight:bold; font-size:1.1em; }
#historyContainer { margin-top:30px; text-align:left; max-height:300px; overflow-y:auto; }
.history-item { padding:8px; margin:4px 0; background:#ffffff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; justify-content:space-between; }
.history-date { font-size:0.85em; color:#555; }
.history-amount { font-weight:600; }
#balanceChangeAnim { position:absolute; font-weight:bold; font-size:1.2em; pointer-events:none; transition: all 1s ease-out; opacity:1; }
</style>
</head>
<body>

<div id="sidebar">
  <h4 id="toggleAuth">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
  <div id="authForm">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
    <p id="authStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
  </div>
</div>

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn"><span>üí∞</span> –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>

  <div id="historyContainer">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
    <div id="historyList">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNk1We9du5BJyrgGbQrkqd7tSDscneIOA",
  authDomain: "gold-11fa4.firebaseapp.com",
  databaseURL: "https://gold-11fa4-default-rtdb.firebaseio.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.firebasestorage.app",
  messagingSenderId: "226774330161",
  appId: "1:226774330161:web:d1e1c93ade5dcea31d5e10",
  measurementId: "G-7MLLBN1YZ4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");
const historyList = document.getElementById("historyList");

let rate = 15000;
let lastBalance = 0; 
let holidays = ["2025-01-01","2025-03-08","2025-03-21","2025-03-22","2025-03-23","2025-05-01","2025-05-07","2025-05-09","2025-07-06","2025-08-30","2025-12-16","2025-12-17"];

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtnEl = document.getElementById("loginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const toggleAuth = document.getElementById("toggleAuth");
const authForm = document.getElementById("authForm");

// –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã
toggleAuth.onclick = ()=>{ authForm.classList.toggle("show"); }

loginBtnEl.onclick = async () => { try { await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);} catch(e){ alert("–û—à–∏–±–∫–∞: "+e.message);} };
logoutBtnEl.onclick = async()=>{await signOut(auth);}

onAuthStateChanged(auth,user=>{
  if(user){
    authStatus.textContent="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+user.email;
    loginBtnEl.style.display="none"; logoutBtnEl.style.display="inline-block";
    emailInput.style.display=passwordInput.style.display="none";
    authForm.classList.remove("show"); 
    toggleAuth.textContent="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    enableEditing(true);
  } else {
    authStatus.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtnEl.style.display="inline-block"; logoutBtnEl.style.display="none";
    emailInput.style.display=passwordInput.style.display="inline-block";
    toggleAuth.textContent="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è";
    enableEditing(false);
  }
});

function enableEditing(enabled){
  manualAmount.disabled = !enabled;
  addBtn.disabled = !enabled;
}

const balanceDocRef = doc(db,"salaryData","balance");
// corrected: entries should be a subcollection of the balance document
const entriesColRef = collection(balanceDocRef, "entries");

// --- –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ ---
function animateBalanceChange(newBalance, prevBalance, changeAmount=0){
  let steps = 20;
  let step = 0;
  let interval = setInterval(()=>{
    step++;
    let val = prevBalance + ((newBalance - prevBalance)/steps)*step;
    balanceDisplay.textContent = Math.round(val).toLocaleString('ru-RU');
    if(step>=steps) clearInterval(interval);
  },20);
  balanceDisplay.style.color = (newBalance-prevBalance>=0)?"#2e7d32":"#c62828";

  if(changeAmount !== 0){
    const anim = document.createElement("div");
    anim.id="balanceChangeAnim";
    anim.textContent = (changeAmount>0?"+":"-")+Math.abs(changeAmount).toLocaleString('ru-RU');
    anim.style.color = (changeAmount>0?"#2e7d32":"#c62828");
    anim.style.left = balanceDisplay.getBoundingClientRect().left + window.scrollX + "px";
    anim.style.top = balanceDisplay.getBoundingClientRect().top + window.scrollY - 30 + "px";
    document.body.appendChild(anim);
    setTimeout(()=>{
      anim.style.top = (balanceDisplay.getBoundingClientRect().top + window.scrollY - 60) + "px";
      anim.style.opacity = "0";
    },50);
    setTimeout(()=>anim.remove(),1000);
  }
}

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ ---
async function updateHistory(){
  try{
    const q = query(entriesColRef, orderBy("date","desc"));
    const snapshot = await getDocs(q);
    if(snapshot.empty){ historyList.innerHTML="–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; return; }
    historyList.innerHTML = "";
    snapshot.forEach(d=>{
      const data = d.data();
      const date = data.date ? new Date(data.date).toLocaleString() : "‚Äî";
      const amount = (typeof data.amount === "number") ? data.amount.toLocaleString('ru-RU') : String(data.amount);
      const sign = data.amount>=0?"+":"-";
      const div = document.createElement("div");
      div.className="history-item";
      div.innerHTML = `<div class="history-date">${date}</div>
                       <div class="history-amount" style="color:${data.amount>=0?"#2e7d32":"#c62828"}">${sign}${amount}</div>`;
      historyList.appendChild(div);
    });
  }catch(e){
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:", e);
    historyList.innerHTML="–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π";
  }
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ ---
async function initBalance(){
  try{
    const docSnap = await getDoc(balanceDocRef);
    if(docSnap && docSnap.exists()){
      const data = docSnap.data();
      lastBalance = (typeof data.balance === "number") ? data.balance : 0;
    } else {
      // default initial balance
      lastBalance = 161000;
      try{
        // try to persist initial balance if rules allow
        await setDoc(balanceDocRef,{balance:lastBalance});
      }catch(e){
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Å—É–º–º—É –≤ Firestore (–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏). –ë—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.", e);
      }
    }
    balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
    updateHistory();

    // –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±–∞–ª–∞–Ω—Å–∞
    onSnapshot(balanceDocRef,(snapshotDoc)=>{
      if(snapshotDoc && snapshotDoc.exists()){
        let newBalance = snapshotDoc.data().balance;
        animateBalanceChange(newBalance,lastBalance,newBalance-lastBalance);
        lastBalance = newBalance;
      }
      updateHistory();
    }, (err) => {
      console.error("–û—à–∏–±–∫–∞ onSnapshot:", err);
    });
  }catch(e){
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞:", e);
    // fallback: –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –Ω–∞—á–∞–ª—å–Ω—É—é —Å—É–º–º—É
    lastBalance = lastBalance || 161000;
    balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
    historyList.innerHTML = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π";
  }
}

// --- –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ---
addBtn.onclick = async ()=>{
  try{
    let value = parseFloat(manualAmount.value);
    if(isNaN(value)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!");
    const docSnap = await getDoc(balanceDocRef);
    let currentBalance = docSnap && docSnap.exists()?docSnap.data().balance:lastBalance;
    currentBalance = (typeof currentBalance === "number") ? (currentBalance + value) : value;
    // try to persist
    try{
      await setDoc(balanceDocRef,{balance:currentBalance});
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ Firestore:", e);
      // still update locally so user sees change
      lastBalance = currentBalance;
      balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
    }
    try{
      await addDoc(entriesColRef,{date:new Date().toISOString(),amount:value});
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é (Firestore):", e);
    }
    manualAmount.value = "";
    updateHistory();
  }catch(e){
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏:", e);
    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
  }
}

// --- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ ---
function scheduleDailyAddition(){
  const now = new Date();
  const next22 = new Date();
  next22.setHours(22,0,0,0);
  if(now>next22) next22.setDate(next22.getDate()+1);
  const msUntil22 = next22 - now;
  setTimeout(async ()=>{
    await addDailyRate();
    scheduleDailyAddition();
  }, msUntil22);
}

async function addDailyRate(){
  try{
    const docSnap = await getDoc(balanceDocRef);
    let currentBalance = docSnap && docSnap.exists()?docSnap.data().balance:lastBalance;
    let todayStr = new Date().toISOString().split("T")[0];
    let todayRate = holidays.includes(todayStr)?20000:rate;
    currentBalance = (typeof currentBalance === "number") ? (currentBalance + todayRate) : todayRate;
    try{
      await setDoc(balanceDocRef,{balance:currentBalance});
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞–≤–∫—É –≤ Firestore:", e);
      lastBalance = currentBalance;
      balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
    }
    try{
      await addDoc(entriesColRef,{date:new Date().toISOString(),amount:todayRate});
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é:", e);
    }
    updateHistory();
  }catch(e){
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏:", e);
  }
}

initBalance();
scheduleDailyAddition();
</script>
</body>
</html>
