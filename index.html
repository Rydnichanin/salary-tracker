<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Salary Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; }
input, button { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
#history { margin-top: 20px; }
.history-item { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; gap: 8px; }
.history-left { flex: 1; }
.history-actions { display: flex; gap: 6px; }
.small-btn { padding: 4px 8px; width: auto; }
canvas { margin-top: 20px; max-width: 100%; }
#auth-section { margin-bottom: 20px; }
.user-info { display: flex; align-items: center; gap: 10px; }
.user-photo { border-radius: 50%; width: 40px; height: 40px; }
</style>
</head>
<body>

<h1>Salary Tracker</h1>

<div id="auth-section">
  <div id="signed-out" style="display: none;">
    <p>Please sign in to use the Salary Tracker:</p>
    <button onclick="signInWithGoogle()" style="width: auto;">Sign in with Google</button>
  </div>
  <div id="signed-in" style="display: none;">
    <div class="user-info">
      <img id="user-photo" class="user-photo" src="" alt="User photo">
      <span id="user-name"></span>
      <button onclick="signOut()" style="width: auto;">Sign Out</button>
    </div>
  </div>
</div>

<div id="app-content" style="display: none;">
<h2>Учёт зарплаты</h2>

<label>Дата транзакции:</label>
<input type="date" id="transDate">

<label>Сумма (положительное число — аванс, отрицательное — выплата):</label>
<input type="number" id="change">

<div style="display:flex; gap:8px;">
  <button id="saveBtn" onclick="addOrSaveTransaction()">Добавить транзакцию</button>
  <button id="cancelBtn" onclick="cancelEdit()" style="display:none; width: 150px;">Отменить</button>
</div>

<div id="history"></div>
<div id="result"></div>

<canvas id="salaryChart" width="700" height="300"></canvas>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, getDocs, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx",
    authDomain: "gold-11fa4.firebaseapp.com",
    projectId: "gold-11fa4",
    storageBucket: "gold-11fa4.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef1234567890abcdef"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUser = null;

  // Google Sign-In
  window.signInWithGoogle = async function() {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      console.log('Signed in:', result.user.displayName);
    } catch (error) {
      console.error('Error signing in:', error);
      alert('Error signing in: ' + error.message);
    }
  };

  // Sign Out
  window.signOut = async function() {
    try {
      await firebaseSignOut(auth);
      console.log('Signed out');
    } catch (error) {
      console.error('Error signing out:', error);
    }
  };

  // Auth State Observer
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      // User is signed in
      document.getElementById('signed-in').style.display = 'block';
      document.getElementById('signed-out').style.display = 'none';
      document.getElementById('app-content').style.display = 'block';
      document.getElementById('user-name').textContent = user.displayName;
      document.getElementById('user-photo').src = user.photoURL;
      
      // Load transactions from Firestore
      await loadTransactionsFromFirestore();
      updateDisplay();
    } else {
      // User is signed out
      document.getElementById('signed-in').style.display = 'none';
      document.getElementById('signed-out').style.display = 'block';
      document.getElementById('app-content').style.display = 'none';
      transactions = [];
    }
  });

  // Load transactions from Firestore
  async function loadTransactionsFromFirestore() {
    if (!currentUser) return;
    
    try {
      const q = query(collection(db, 'users', currentUser.uid, 'transactions'), orderBy('date'));
      const querySnapshot = await getDocs(q);
      transactions = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        transactions.push({
          id: doc.id,
          date: data.date,
          amount: data.amount
        });
      });
    } catch (error) {
      console.error('Error loading transactions:', error);
    }
  }

  // Save transaction to Firestore
  async function saveTransactionToFirestore(transaction) {
    if (!currentUser) return null;
    
    try {
      const docRef = await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), {
        date: transaction.date,
        amount: transaction.amount,
        timestamp: serverTimestamp()
      });
      return docRef.id;
    } catch (error) {
      console.error('Error saving transaction:', error);
      throw error;
    }
  }

  // Update transaction in Firestore
  async function updateTransactionInFirestore(id, transaction) {
    if (!currentUser) return;
    
    try {
      const docRef = doc(db, 'users', currentUser.uid, 'transactions', id);
      await updateDoc(docRef, {
        date: transaction.date,
        amount: transaction.amount
      });
    } catch (error) {
      console.error('Error updating transaction:', error);
      throw error;
    }
  }

  // Delete transaction from Firestore
  async function deleteTransactionFromFirestore(id) {
    if (!currentUser) return;
    
    try {
      await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
    } catch (error) {
      console.error('Error deleting transaction:', error);
      throw error;
    }
  }

  // Make Firestore functions available globally
  window.loadTransactionsFromFirestore = loadTransactionsFromFirestore;
  window.saveTransactionToFirestore = saveTransactionToFirestore;
  window.updateTransactionInFirestore = updateTransactionInFirestore;
  window.deleteTransactionFromFirestore = deleteTransactionFromFirestore;
</script>

<script>
// ----- Настройки -----
let rate = 15000;
let startDate = new Date("2025-10-23");

// ----- Загрузка транзакций из Firestore -----
let transactions = [];

// индекс редактируемой транзакции, -1 = не редактируется
let editingIndex = -1;

// ----- Подсчёт баланса по дням -----
function calculateBalance() {
    let today = new Date();
    let daysWorked = Math.floor((today - startDate)/(1000*60*60*24)) + 1;
    if (daysWorked < 1) daysWorked = 1;
    let balanceByDay = [];
    let total = 0;

    for (let i=0; i<daysWorked; i++) {
        total += rate;
        let currentDate = new Date(startDate);
        currentDate.setDate(currentDate.getDate() + i);
        transactions.forEach(t => {
            let tDate = new Date(t.date);
            if (tDate.toDateString() === currentDate.toDateString()) total -= t.amount;
        });
        balanceByDay.push({date: new Date(currentDate), balance: total});
    }
    return balanceByDay;
}

// ----- Добавление или сохранение транзакции (редактирование) -----
async function addOrSaveTransaction() {
    let dateInput = document.getElementById('transDate').value;
    let amount = parseFloat(document.getElementById('change').value);
    if (!dateInput || isNaN(amount)) return alert("Заполните дату и сумму.");

    try {
        if (editingIndex >= 0) {
            // сохраняем изменения
            const transaction = transactions[editingIndex];
            transactions[editingIndex] = {id: transaction.id, date: dateInput, amount: amount};
            await window.updateTransactionInFirestore(transaction.id, {date: dateInput, amount: amount});
            editingIndex = -1;
        } else {
            // добавляем новую транзакцию
            const newTransaction = {date: dateInput, amount: amount};
            const id = await window.saveTransactionToFirestore(newTransaction);
            transactions.push({id: id, date: dateInput, amount: amount});
        }

        // очистка формы и обновление UI
        clearForm();
        updateDisplay();
    } catch (error) {
        alert('Error saving transaction: ' + error.message);
    }
}

// ----- Начать редактирование записи -----
function startEdit(i) {
    const t = transactions[i];
    document.getElementById('transDate').value = t.date;
    document.getElementById('change').value = t.amount;
    editingIndex = i;
    document.getElementById('saveBtn').textContent = "Сохранить изменение";
    document.getElementById('cancelBtn').style.display = "inline-block";
}

// ----- Отмена редактирования -----
function cancelEdit() {
    editingIndex = -1;
    clearForm();
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Удаление транзакции -----
async function deleteTransaction(i) {
    if (!confirm("Удалить эту транзакцию?")) return;
    
    try {
        const transaction = transactions[i];
        await window.deleteTransactionFromFirestore(transaction.id);
        transactions.splice(i,1);
        
        // если удалили тот, что редактировался, отменяем режим редактирования
        if (editingIndex === i) cancelEdit();
        else if (editingIndex > i) editingIndex--; // сдвиг индекса
        updateDisplay();
    } catch (error) {
        alert('Error deleting transaction: ' + error.message);
    }
}

// ----- Очистка полей формы -----
function clearForm() {
    document.getElementById('transDate').value = "";
    document.getElementById('change').value = "";
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Отображение истории и баланса -----
function updateDisplay() {
    // История транзакций
    let historyHTML = "<h3>История транзакций:</h3>";
    if (transactions.length === 0) {
        historyHTML += "<div>Транзакций нет</div>";
    } else {
        transactions.forEach((t,i)=>{
            const sign = t.amount > 0 ? '+' : '-';
            const abs = Math.abs(t.amount).toLocaleString('ru-RU');
            historyHTML += `<div class="history-item">
                <div class="history-left">${t.date}: ${sign}${abs}</div>
                <div class="history-actions">
                  <button class="small-btn" onclick="startEdit(${i})">Редактировать</button>
                  <button class="small-btn" onclick="deleteTransaction(${i})">Удалить</button>
                </div>
            </div>`;
        });
    }
    document.getElementById('history').innerHTML = historyHTML;

    // Баланс
    let balanceByDay = calculateBalance();
    let totalBalance = balanceByDay[balanceByDay.length-1]?.balance || 0;
    document.getElementById('result').innerHTML = `<h3>Итог: ${totalBalance.toLocaleString('ru-RU')} тенге</h3>`;

    // График
    drawChart(balanceByDay);
}

// ----- Построение графика -----
function drawChart(balanceByDay) {
    const ctx = document.getElementById('salaryChart').getContext('2d');
    if(window.salaryChartInstance) window.salaryChartInstance.destroy();
    window.salaryChartInstance = new Chart(ctx,{
        type:'line',
        data:{
            labels: balanceByDay.map(b=>b.date.toISOString().split('T')[0]),
            datasets:[{
                label:'Баланс',
                data: balanceByDay.map(b=>b.balance),
                borderColor:'green',
                fill:false,
                tension:0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ----- Инициализация -----
// updateDisplay will be called by onAuthStateChanged when user signs in
</script>
</body>
</html>
