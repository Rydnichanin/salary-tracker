<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ó–∞—Ä–ø–ª–∞—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{ --accent:#00796b; --accent-dark:#004d40; --card-bg: rgba(255,255,255,0.78); --card-shadow: 0 12px 30px rgba(6,22,37,0.12); }
html,body{ height:100%; margin:0; font-family:'Inter',sans-serif; background:linear-gradient(120deg,#f0fbff 0%,#f6fff7 40%,#fffaf0 100%); color:#04363a; }
#main{ max-width:640px; margin:80px auto; text-align:center; padding:34px; background:var(--card-bg); border-radius:20px; box-shadow:var(--card-shadow); }
#sidebar{ position:fixed; top:20px; right:20px; width:260px; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.70)); padding:16px 22px; border-radius:14px; box-shadow:0 12px 30px rgba(6,22,37,0.08); }
#sidebar h4{ margin:0; color:var(--accent); cursor:pointer; user-select:none; }
#authForm{ margin-top:10px; max-height:0; opacity:0; overflow:hidden; transition:max-height 0.28s, opacity 0.28s; }
#authForm.show{ max-height:220px; opacity:1; }
input,button{ padding:9px; margin:8px 0; width:100%; border-radius:10px; border:1px solid #dbe9e6; font-size:0.96em; }
button{ background:var(--accent); color:#fff; border:none; cursor:pointer; }
button:hover{ background:var(--accent-dark); }
button:disabled{ background:#bbb; cursor:not-allowed; }
#balanceDisplay{ font-size:2.6em; margin-bottom:14px; font-weight:600; }
#manualAmount,#addBtn{ margin-top:14px; font-size:1em; }
#historyContainer{ margin-top:34px; text-align:left; max-height:340px; overflow-y:auto; }
.history-item{ padding:10px; margin:6px 0; background:rgba(255,255,255,0.85); border-radius:10px; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div id="sidebar">
  <h4 id="toggleAuth">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
  <div id="authForm">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
    <p id="authStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
  </div>
</div>

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn">üí∞ –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>

  <div id="historyContainer">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
    <div id="historyList">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

// Firebase config
const firebaseConfig = { /* —Ç–≤–æ–π firebaseConfig */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");
const historyList = document.getElementById("historyList");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtnEl = document.getElementById("loginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const toggleAuth = document.getElementById("toggleAuth");
const authForm = document.getElementById("authForm");

const SALARY_PER_DAY = 15000;
let lastBalance = 176000;
const balanceDocRef = doc(db,"salaryData","balance");
const entriesColRef = collection(balanceDocRef,"entries");

// UI
toggleAuth.onclick = ()=> authForm.classList.toggle("show");
loginBtnEl.onclick = async ()=> { try { await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); alert("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω"); } catch(e){ console.error(e); alert(e.message); } };
logoutBtnEl.onclick = async ()=> { try { await signOut(auth); alert("–í—ã –≤—ã—à–ª–∏"); } catch(e){ console.error(e); alert(e.message); } };
function enableEditing(enabled){ manualAmount.disabled = !enabled; addBtn.disabled = !enabled; }

function animateBalanceChange(newBalance){
  balanceDisplay.textContent = Math.round(newBalance).toLocaleString('ru-RU');
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –Ω–∞—á–∏—Å–ª—è–µ–º –∑–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–Ω–∏
async function updateDailyBalance(){
  const snap = await getDoc(balanceDocRef);
  let balance = 176000;
  let lastAddedDate = null;

  if(snap.exists){
    const data = snap.data();
    balance = data.balance ?? 176000;
    lastAddedDate = data.lastAddedDate?.toDate() ?? null;
  }

  const today = new Date();
  let daysToAdd = 0;

  if(lastAddedDate){
    const diffTime = today - lastAddedDate;
    daysToAdd = Math.floor(diffTime / (1000*60*60*24));
  } else { daysToAdd = 1; }

  if(daysToAdd>0){
    const added = daysToAdd * SALARY_PER_DAY;
    balance += added;
    await setDoc(balanceDocRef,{ balance, lastAddedDate: new Date() }, { merge:true });
    await addDoc(entriesColRef,{ date: serverTimestamp(), amount: added });
  }

  lastBalance = balance;
  animateBalanceChange(balance);
  updateHistory();
}

// –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function updateHistory(){
  try{
    const q = query(entriesColRef, orderBy("date","desc"));
    const snap = await getDocs(q);
    if(snap.empty){ historyList.innerHTML="–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; return; }
    historyList.innerHTML="";
    snap.forEach(d=>{
      const data = d.data();
      const dateStr = data.date?.toDate ? data.date.toDate().toLocaleString() : "-";
      const sign = (data.amount>=0)?"+":"-";
      const div = document.createElement("div");
      div.className="history-item";
      div.innerHTML = `<div>${dateStr}</div><div style="color:${data.amount>=0?"#2e7d32":"#c62828"}">${sign}${Math.abs(data.amount).toLocaleString('ru-RU')}</div>`;
      historyList.appendChild(div);
    });
  }catch(e){ console.error(e); }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
addBtn.onclick = async ()=>{
  let value = parseFloat(manualAmount.value);
  if(isNaN(value)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!");
  const newBalance = lastBalance + value;
  await setDoc(balanceDocRef,{ balance: newBalance, lastAddedDate: new Date() }, { merge:true });
  await addDoc(entriesColRef,{ date: serverTimestamp(), amount: value });
  lastBalance = newBalance;
  animateBalanceChange(newBalance);
  manualAmount.value="";
  updateHistory();
};

// –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
onAuthStateChanged(auth,user=>{
  if(user){
    authStatus.textContent="–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "+user.email;
    loginBtnEl.style.display="none";
    logoutBtnEl.style.display="inline-block";
    emailInput.style.display=passwordInput.style.display="none";
    authForm.classList.remove("show");
    toggleAuth.textContent="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    enableEditing(true);
  } else {
    authStatus.textContent="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtnEl.style.display="inline-block";
    logoutBtnEl.style.display="none";
    emailInput.style.display=passwordInput.style.display="inline-block";
    toggleAuth.textContent="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è";
    enableEditing(false);
  }
});

// –ö–ª–∏–∫ –≤–Ω–µ —Å–∞–π–¥–±–∞—Ä–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É
document.addEventListener('click',(e)=>{
  const sidebar = document.getElementById('sidebar');
  if(!sidebar.contains(e.target)) authForm.classList.remove('show');
});

// –ó–∞–ø—É—Å–∫
updateDailyBalance();
</script>
</body>
</html>
