<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ó–∞—Ä–ø–ª–∞—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{ --accent:#00796b; --accent-dark:#004d40; --card-bg: rgba(255,255,255,0.78); --card-shadow: 0 12px 30px rgba(6,22,37,0.12); }
html,body{ height:100%; }
body{ font-family:'Inter',sans-serif; margin:0; padding:0; min-height:100vh; position:relative; overflow-x:hidden; background:linear-gradient(120deg,#f0fbff 0%,#f6fff7 40%,#fffaf0 100%); color:#04363a; }
#main{ max-width:640px; margin:80px auto; text-align:center; padding:34px; background:var(--card-bg); border-radius:20px; box-shadow:var(--card-shadow); z-index:1; transition:transform 0.18s ease; }
#sidebar{ position:fixed; top:20px; right:20px; width:260px; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.70)); padding:16px 22px; border-radius:14px; box-shadow:0 12px 30px rgba(6,22,37,0.06); }
#sidebar h4{ margin:0; color:var(--accent); cursor:pointer; user-select:none; }
#authForm{ margin-top:10px; max-height:0; opacity:0; transition:max-height 0.28s ease, opacity 0.28s ease; overflow:hidden; }
#authForm.show{ max-height:220px; opacity:1; }
input,button{ padding:9px; margin:8px 0; width:100%; box-sizing:border-box; border-radius:10px; border:1px solid #dbe9e6; font-size:0.96em; }
button{ background:var(--accent); color:#fff; border:none; cursor:pointer; transition:0.18s; }
button:hover{ background:var(--accent-dark); }
button:disabled{ background:#bbb; cursor:not-allowed; }
#authStatus{ font-size:0.86em; color:#375651; margin-top:6px; }
#balanceDisplay{ font-size:2.6em; margin-bottom:14px; font-weight:600; letter-spacing:0.4px; transition:color 0.18s ease; }
#manualAmount,#addBtn{ margin-top:14px; font-size:1em; }
#addBtn{ display:flex; align-items:center; justify-content:center; gap:8px; }
#historyContainer{ margin-top:34px; text-align:left; max-height:340px; overflow-y:auto; }
.history-item{ padding:10px; margin:6px 0; background:rgba(255,255,255,0.85); border-radius:10px; box-shadow:0 4px 10px rgba(6,22,37,0.06); display:flex; justify-content:space-between; align-items:center; }
.float-change {
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:20px;
  background:rgba(0,0,0,0.75);
  color:#fff;
  padding:6px 12px;
  border-radius:10px;
  z-index:99999;
  font-weight:600;
  pointer-events:none;
  opacity:0;
  transition:transform 0.6s cubic-bezier(.2,.9,.2,1), opacity 0.3s ease;
}
.float-change.show { opacity:1; transform:translateX(-50%) translateY(12px); }
@media (max-width:700px){ #main{ margin:60px 18px; padding:22px; } #sidebar{ width:calc(100% - 40px); right:20px; left:20px; top:auto; bottom:20px; } }
</style>
</head>
<body>

<div id="sidebar">
  <h4 id="toggleAuth">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
  <div id="authForm">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <button id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
    <p id="authStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
  </div>
</div>

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn"><span>üí∞</span> –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>
  <p style="font-size:0.85em; color:#00796b; margin-top:12px;">‚ÑπÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º</p>

  <div id="historyContainer">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
    <div id="historyList">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  </div>
</div>

<!-- –º–µ—Å—Ç–æ –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div id="floatChange" class="float-change" aria-hidden="true"></div>

<script type="module">
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showToast(text, timeout = 3500){
  let t = document.getElementById('__app_toast__');
  if(!t){
    t = document.createElement('div'); t.id='__app_toast__';
    Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'rgba(6,22,37,0.9)',color:'#fff',padding:'10px 16px',borderRadius:'10px',zIndex:99999,fontFamily:'Inter, sans-serif'});
    document.body.appendChild(t);
  }
  t.textContent = text;
  t.style.opacity = '1';
  clearTimeout(t.__hideTimer);
  t.__hideTimer = setTimeout(()=> t.style.opacity='0', timeout);
}

// Firebase (CDN, modular)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot, collection,
  addDoc, query, orderBy, getDocs, writeBatch, serverTimestamp, where
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

// –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à firebaseConfig (–≤ —Ä–µ–ø–æ —É–∂–µ –µ—Å—Ç—å)
const firebaseConfig = {
  apiKey: "AIzaSyDNk1We9du5BJyrgGbQrkqd7tSDscneIOA",
  authDomain: "gold-11fa4.firebaseapp.com",
  databaseURL: "https://gold-11fa4-default-rtdb.firebaseio.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.firebasestorage.app",
  messagingSenderId: "226774330161",
  appId: "1:226774330161:web:d1e1c93ade5dcea31d5e10",
  measurementId: "G-7MLLBN1YZ4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Elements
const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");
const historyList = document.getElementById("historyList");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtnEl = document.getElementById("loginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const toggleAuth = document.getElementById("toggleAuth");
const authForm = document.getElementById("authForm");
const floatChange = document.getElementById('floatChange');

// Settings
const DAILY_RATE = 15000;
let lastBalance = 0; // –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–∑ Firestore
let holidays = []; // –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–∞—Ç—ã YYYY-MM-DD

// privilege flag for automated behavior (keeps original meaning)
let currentUserIsAutomated = false;

const balanceDocRef = doc(db,"salaryData","balance");
const entriesColRef = collection(balanceDocRef, "entries");

// UI handlers
toggleAuth.onclick = ()=> authForm.classList.toggle("show");
loginBtnEl.onclick = async ()=> {
  try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }
  catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e.message || e)); }
};
logoutBtnEl.onclick = async ()=> {
  try { await signOut(auth); showToast('–í—ã –≤—ã—à–ª–∏'); }
  catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞'); }
};

function enableEditing(enabled){
  manualAmount.disabled = !enabled;
  addBtn.disabled = !enabled;
  manualAmount.style.opacity = enabled ? '1' : '0.6';
}

// Smooth numeric animation for balance + floating change badge
function animateBalanceChange(newBalance, prevBalance, changeAmount = 0, duration = 700){
  const from = Number(prevBalance) || 0;
  const to = Number(newBalance) || 0;
  // color based on net difference
  balanceDisplay.style.color = (to - from >= 0) ? "#2e7d32" : "#c62828";

  // numeric animation
  const start = performance.now();
  function step(ts){
    const t = Math.min(1, (ts - start) / duration);
    // easeOutCubic
    const eased = 1 - Math.pow(1 - t, 3);
    const current = Math.round(from + (to - from) * eased);
    balanceDisplay.textContent = current.toLocaleString('ru-RU');
    if(t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  // floating change badge
  if(changeAmount !== 0){
    const sign = changeAmount > 0 ? "+" : "-";
    floatChange.textContent = `${sign}${Math.abs(changeAmount).toLocaleString('ru-RU')}`;
    floatChange.classList.add('show');
    floatChange.style.background = (changeAmount>0) ? 'rgba(46,125,50,0.9)' : 'rgba(198,40,40,0.9)';
    // auto hide
    setTimeout(()=> floatChange.classList.remove('show'), 1400);
  }
}

// History UI
async function updateHistory(){
  try{
    const q = query(entriesColRef, orderBy("serverCreatedAt","desc"));
    const snap = await getDocs(q);
    if(snap.empty){ historyList.innerHTML = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; return; }
    historyList.innerHTML = "";
    snap.forEach(d=>{
      const data = d.data();
      // serverCreatedAt –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∏–±–æ timestamp –ª–∏–±–æ ISO string
      let dateStr = data.dateString || (data.serverCreatedAt && typeof data.serverCreatedAt.toDate === 'function' ? data.serverCreatedAt.toDate().toLocaleString() : (data.serverCreatedAt || '‚Äî'));
      const amount = (typeof data.amount === "number")? data.amount.toLocaleString('ru-RU') : String(data.amount);
      const sign = (data.amount >= 0) ? "+" : "-";
      const div = document.createElement("div"); div.className = "history-item";
      const src = data.source ? ` (${data.source})` : "";
      div.innerHTML = `<div class="history-date">${dateStr}${src}</div><div class="history-amount" style="color:${data.amount>=0?"#2e7d32":"#c62828"}">${sign}${amount}</div>`;
      historyList.appendChild(div);
    });
  }catch(e){ console.warn(e); historyList.innerHTML="–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; }
}

// commitBalanceChange: atomic-ish approach using batch; writes entry with source/manual or automatic.
// options.forceAutomatic = true marks source 'automatic'
async function commitBalanceChange(amount, options = { forceAutomatic: false }){
  const result = { newBalance:null, balanceWritten:false, entryWritten:false, error:null };

  if(!auth.currentUser){
    result.newBalance = (Number(lastBalance)||0) + Number(amount);
    result.error = new Error('not-authenticated');
    return result;
  }

  try{
    const balSnap = await getDoc(balanceDocRef);
    let current = balSnap && balSnap.exists() && typeof balSnap.data().balance === 'number' ? balSnap.data().balance : (Number(lastBalance)||0);
    const newBalance = current + Number(amount);

    try{
      const batch = writeBatch(db);
      batch.set(balanceDocRef, { balance: newBalance }, { merge: true });
      const newEntryRef = doc(entriesColRef);
      const source = options && options.forceAutomatic ? 'automatic' : 'manual';
      batch.set(newEntryRef, { serverCreatedAt: serverTimestamp(), dateString: new Date().toISOString().split('T')[0], amount: Number(amount), source, userId: auth.currentUser ? auth.currentUser.uid : null });
      await batch.commit();
      result.newBalance = newBalance; result.balanceWritten = true; result.entryWritten = true; return result;
    }catch(batchErr){
      console.warn('Batch failed, fallback:', batchErr);
      try{ await setDoc(balanceDocRef, { balance: newBalance }, { merge: true }); result.balanceWritten=true; }catch(e){ result.error=e; }
      try{ await addDoc(entriesColRef,{ serverCreatedAt: new Date().toISOString(), dateString: new Date().toISOString().split('T')[0], amount: Number(amount), source: options && options.forceAutomatic ? 'automatic' : 'manual', userId: auth.currentUser ? auth.currentUser.uid : null }); result.entryWritten=true; }catch(e){ console.warn(e); }
      result.newBalance = newBalance; return result;
    }
  }catch(err){ console.error(err); result.error = err; result.newBalance = (Number(lastBalance)||0) + Number(amount); return result; }
}

// Button handler (manual)
addBtn.onclick = async ()=>{
  let value = parseFloat(manualAmount.value);
  if(isNaN(value)){ showToast('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!'); return; }
  if(!auth.currentUser){
    showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤—Ä—É—á–Ω—É—é');
    return;
  }
  addBtn.disabled = true;
  try{
    const res = await commitBalanceChange(value, { forceAutomatic: false });
    animateBalanceChange(res.newBalance, lastBalance, value);
    lastBalance = res.newBalance; manualAmount.value = "";
    try{ await updateHistory(); }catch(e){ console.warn(e); }
    if(res.balanceWritten && res.entryWritten) showToast('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); else showToast('–ß–∞—Å—Ç–∏—á–Ω–æ–µ/–Ω–µ—É–¥–∞—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)');
  }catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏'); } finally { addBtn.disabled = false; }
};

// CLIENT daily fallback ‚Äî DISABLED when server automatic is enabled
// Server Cloud Function (dailyAdd) handles automatic daily accruals
async function addDailyRateForToday(){
  // Server automatic accruals are enabled - client fallback is disabled
  console.log('Client daily fallback is disabled - server handles automatic accruals');
  return;
}

// Client day watcher: DISABLED - server Cloud Function handles daily accruals
// The setupClientDayWatcher is no longer needed as server handles automatic accruals
(function setupClientDayWatcher(){
  console.log('Client day watcher disabled - server Cloud Function handles daily accruals');
  // No-op: server handles automatic daily additions via Cloud Function
})();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ authForm –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Å–∞–π–¥–±–∞—Ä–∞
document.addEventListener('click', (e)=>{
  const sidebar = document.getElementById('sidebar');
  if(!sidebar.contains(e.target)){
    authForm.classList.remove('show');
  }
});

// init balance and realtime ‚Äî —á–∏—Ç–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ Firestore –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
async function initBalance(){
  try{
    const docSnap = await getDoc(balanceDocRef);
    if(docSnap && docSnap.exists()){
      const data = docSnap.data();
      lastBalance = (typeof data.balance === "number") ? data.balance : Number(data.balance) || 0;
    } else {
      // –µ—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0 (–Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º)
      lastBalance = 0;
    }
    balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU');
    updateHistory();

    onSnapshot(balanceDocRef,(snapshotDoc)=>{
      try{
        if(snapshotDoc && snapshotDoc.exists()){
          let newBalance = snapshotDoc.data().balance;
          animateBalanceChange(newBalance,lastBalance,newBalance-lastBalance);
          lastBalance = newBalance;
        }
        updateHistory();
      }catch(e){ console.error(e); }
    }, (err)=>{ console.error('onSnapshot error:', err); });

  }catch(e){ console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞:', e); balanceDisplay.textContent = lastBalance.toLocaleString('ru-RU'); historyList.innerHTML = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"; }
}

// auth state handling: —á–∏—Ç–∞–µ–º custom claims –∏ –≤–∫–ª—é—á–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
onAuthStateChanged(auth, async user=>{
  if(user){
    authStatus.textContent = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ " + user.email;
    loginBtnEl.style.display = "none";
    logoutBtnEl.style.display = "inline-block";
    emailInput.style.display = passwordInput.style.display = "none";
    authForm.classList.remove("show"); // —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
    toggleAuth.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";

    try{
      const idRes = await user.getIdTokenResult(true);
      currentUserIsAutomated = Boolean(idRes.claims && idRes.claims.automated);
      if(currentUserIsAutomated) showToast('–ü—Ä–∞–≤–∞: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      else showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äî —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
    }catch(e){ console.warn('getIdTokenResult error', e); currentUserIsAutomated = false; }

    // allow manual editing for any logged-in user
    enableEditing(true);

    (async ()=> {
      try{
        const snap = await getDoc(balanceDocRef);
        if(!snap.exists() && currentUserIsAutomated){
          // –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—É–º–º—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
          await setDoc(balanceDocRef, { balance: lastBalance }, { merge:true });
        }
        // Note: daily add is now handled by server Cloud Function (dailyAdd)
        updateHistory();
      }catch(e){ console.warn('Post-login init error:', e); }
    })();

  } else {
    authStatus.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
    loginBtnEl.style.display = "inline-block";
    logoutBtnEl.style.display = "none";
    emailInput.style.display = passwordInput.style.display = "inline-block";
    toggleAuth.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è";
    currentUserIsAutomated = false;
    enableEditing(false);
  }
});

// —Å—Ç–∞—Ä—Ç
initBalance();

</script>
</body>
</html>
