<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Salary Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; }
input, button { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
#history { margin-top: 20px; }
.history-item { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; gap: 8px; }
.history-left { flex: 1; }
.history-actions { display: flex; gap: 6px; }
.small-btn { padding: 4px 8px; width: auto; }
canvas { margin-top: 20px; max-width: 100%; }
#auth-section { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>Salary Tracker</h1>

<div id="auth-section">
  <div id="auth-status">Not signed in</div>
  <button id="signInBtn" onclick="signInWithGoogle()">Sign in with Google</button>
  <button id="signOutBtn" onclick="signOut()" style="display:none;">Sign Out</button>
</div>

<h2>Учёт зарплаты</h2>

<label>Дата транзакции:</label>
<input type="date" id="transDate">

<label>Сумма (положительное число — аванс, отрицательное — выплата):</label>
<input type="number" id="change">

<div style="display:flex; gap:8px;">
  <button id="saveBtn" onclick="addOrSaveTransaction()">Добавить транзакцию</button>
  <button id="cancelBtn" onclick="cancelEdit()" style="display:none; width: 150px;">Отменить</button>
</div>

<div id="history"></div>
<div id="result"></div>

<canvas id="salaryChart" width="700" height="300"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBXVq8K9L4mN5pO6qR7sT8uV9wX0yZ1aB2",
  authDomain: "gold-11fa4.firebaseapp.com",
  projectId: "gold-11fa4",
  storageBucket: "gold-11fa4.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcdef1234567890"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Current user
let currentUser = null;

// Auth state observer
auth.onAuthStateChanged(user => {
  currentUser = user;
  if (user) {
    document.getElementById('auth-status').textContent = `Signed in as ${user.displayName || user.email}`;
    document.getElementById('signInBtn').style.display = 'none';
    document.getElementById('signOutBtn').style.display = 'inline-block';
    loadTransactionsFromFirestore();
  } else {
    document.getElementById('auth-status').textContent = 'Not signed in';
    document.getElementById('signInBtn').style.display = 'inline-block';
    document.getElementById('signOutBtn').style.display = 'none';
    loadTransactionsFromLocalStorage();
  }
});

// Sign in with Google
function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(error => {
    console.error('Sign in error:', error);
    alert('Sign in failed: ' + error.message);
  });
}

// Sign out
function signOut() {
  auth.signOut();
}

// Load transactions from Firestore
function loadTransactionsFromFirestore() {
  if (!currentUser) return;
  db.collection('users').doc(currentUser.uid).collection('transactions')
    .get()
    .then(snapshot => {
      transactions = [];
      snapshot.forEach(doc => {
        transactions.push({ id: doc.id, ...doc.data() });
      });
      updateDisplay();
    })
    .catch(error => {
      console.error('Error loading from Firestore:', error);
      loadTransactionsFromLocalStorage();
    });
}

// Load transactions from LocalStorage
function loadTransactionsFromLocalStorage() {
  transactions = JSON.parse(localStorage.getItem('transactions')) || [];
  updateDisplay();
}

// Save transaction to Firestore
function saveTransactionToFirestore(transaction) {
  if (!currentUser) return Promise.resolve();
  const userTransactions = db.collection('users').doc(currentUser.uid).collection('transactions');
  if (transaction.id) {
    return userTransactions.doc(transaction.id).set({
      date: transaction.date,
      amount: transaction.amount
    });
  } else {
    return userTransactions.add({
      date: transaction.date,
      amount: transaction.amount
    }).then(docRef => {
      transaction.id = docRef.id;
    });
  }
}

// Delete transaction from Firestore
function deleteTransactionFromFirestore(transactionId) {
  if (!currentUser || !transactionId) return Promise.resolve();
  return db.collection('users').doc(currentUser.uid).collection('transactions').doc(transactionId).delete();
}

// ----- Настройки -----
let rate = 15000;
let startDate = new Date("2025-10-23");

// ----- Загрузка транзакций из LocalStorage -----
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

// индекс редактируемой транзакции, -1 = не редактируется
let editingIndex = -1;

// ----- Подсчёт баланса по дням -----
function calculateBalance() {
    let today = new Date();
    let daysWorked = Math.floor((today - startDate)/(1000*60*60*24)) + 1;
    if (daysWorked < 1) daysWorked = 1;
    let balanceByDay = [];
    let total = 0;

    for (let i=0; i<daysWorked; i++) {
        total += rate;
        let currentDate = new Date(startDate);
        currentDate.setDate(currentDate.getDate() + i);
        transactions.forEach(t => {
            let tDate = new Date(t.date);
            if (tDate.toDateString() === currentDate.toDateString()) total -= t.amount;
        });
        balanceByDay.push({date: new Date(currentDate), balance: total});
    }
    return balanceByDay;
}

// ----- Добавление или сохранение транзакции (редактирование) -----
function addOrSaveTransaction() {
    let dateInput = document.getElementById('transDate').value;
    let amount = parseFloat(document.getElementById('change').value);
    if (!dateInput || isNaN(amount)) return alert("Заполните дату и сумму.");

    if (editingIndex >= 0) {
        // сохраняем изменения
        transactions[editingIndex] = {
          ...transactions[editingIndex],
          date: dateInput, 
          amount: amount
        };
        const transaction = transactions[editingIndex];
        saveTransactionToFirestore(transaction).then(() => {
          editingIndex = -1;
          localStorage.setItem('transactions', JSON.stringify(transactions));
          clearForm();
          updateDisplay();
        });
    } else {
        // добавляем новую транзакцию
        const newTransaction = {date: dateInput, amount: amount};
        transactions.push(newTransaction);
        saveTransactionToFirestore(newTransaction).then(() => {
          localStorage.setItem('transactions', JSON.stringify(transactions));
          clearForm();
          updateDisplay();
        });
    }
}

// ----- Начать редактирование записи -----
function startEdit(i) {
    const t = transactions[i];
    document.getElementById('transDate').value = t.date;
    document.getElementById('change').value = t.amount;
    editingIndex = i;
    document.getElementById('saveBtn').textContent = "Сохранить изменение";
    document.getElementById('cancelBtn').style.display = "inline-block";
}

// ----- Отмена редактирования -----
function cancelEdit() {
    editingIndex = -1;
    clearForm();
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Удаление транзакции -----
function deleteTransaction(i) {
    if (!confirm("Удалить эту транзакцию?")) return;
    const transaction = transactions[i];
    deleteTransactionFromFirestore(transaction.id).then(() => {
      transactions.splice(i,1);
      localStorage.setItem('transactions', JSON.stringify(transactions));
      if (editingIndex === i) cancelEdit();
      else if (editingIndex > i) editingIndex--;
      updateDisplay();
    });
}

// ----- Очистка полей формы -----
function clearForm() {
    document.getElementById('transDate').value = "";
    document.getElementById('change').value = "";
    document.getElementById('saveBtn').textContent = "Добавить транзакцию";
    document.getElementById('cancelBtn').style.display = "none";
}

// ----- Отображение истории и баланса -----
function updateDisplay() {
    // История транзакций
    let historyHTML = "<h3>История транзакций:</h3>";
    if (transactions.length === 0) {
        historyHTML += "<div>Транзакций нет</div>";
    } else {
        transactions.forEach((t,i)=>{
            const sign = t.amount > 0 ? '+' : '-';
            const abs = Math.abs(t.amount).toLocaleString('ru-RU');
            historyHTML += `<div class="history-item">
                <div class="history-left">${t.date}: ${sign}${abs}</div>
                <div class="history-actions">
                  <button class="small-btn" onclick="startEdit(${i})">Редактировать</button>
                  <button class="small-btn" onclick="deleteTransaction(${i})">Удалить</button>
                </div>
            </div>`;
        });
    }
    document.getElementById('history').innerHTML = historyHTML;

    // Баланс
    let balanceByDay = calculateBalance();
    let totalBalance = balanceByDay[balanceByDay.length-1]?.balance || 0;
    document.getElementById('result').innerHTML = `<h3>Итог: ${totalBalance.toLocaleString('ru-RU')} тенге</h3>`;

    // График
    drawChart(balanceByDay);
}

// ----- Построение графика -----
function drawChart(balanceByDay) {
    const ctx = document.getElementById('salaryChart').getContext('2d');
    if(window.salaryChartInstance) window.salaryChartInstance.destroy();
    window.salaryChartInstance = new Chart(ctx,{
        type:'line',
        data:{
            labels: balanceByDay.map(b=>b.date.toISOString().split('T')[0]),
            datasets:[{
                label:'Баланс',
                data: balanceByDay.map(b=>b.balance),
                borderColor:'green',
                fill:false,
                tension:0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ----- Инициализация -----
updateDisplay();
</script>
</body>
</html>
