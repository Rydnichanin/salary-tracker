<!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->

<div id="main">
  <div id="balanceDisplay">0</div>
  <input type="number" id="manualAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–ø–ª—é—Å/–º–∏–Ω—É—Å)">
  <button id="addBtn"><span>üí∞</span> –î–æ–±–∞–≤–∏—Ç—å/–í—ã—á–µ—Å—Ç—å</button>

  <div id="historyContainer">
    <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</h4>
    <div id="historyList">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
  </div>
</div>

<style>
/* –ú–∏–Ω–∏-–∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É–º–º—ã */
#balanceChangeAnim {
  position: absolute;
  font-weight: bold;
  font-size: 1.2em;
  pointer-events: none;
  transition: all 1s ease-out;
  opacity: 1;
}
</style>

<script type="module">
/* ... –∫–æ–¥ Firebase –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */

const balanceDisplay = document.getElementById("balanceDisplay");
const manualAmount = document.getElementById("manualAmount");
const addBtn = document.getElementById("addBtn");
const historyList = document.getElementById("historyList");

let lastBalance = 161000;

/* --- –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π —Å—É–º–º–æ–π --- */
function animateBalanceChange(newBalance, prevBalance, changeAmount=0){
  let steps = 20;
  let step = 0;
  let interval = setInterval(()=>{
    step++;
    let val = prevBalance + ((newBalance - prevBalance)/steps)*step;
    balanceDisplay.textContent = Math.round(val).toLocaleString('ru-RU');
    if(step>=steps) clearInterval(interval);
  },20);
  balanceDisplay.style.color = (newBalance-prevBalance>=0)?"#2e7d32":"#c62828";

  if(changeAmount !== 0){
    const anim = document.createElement("div");
    anim.id="balanceChangeAnim";
    anim.textContent = (changeAmount>0?"+":"-")+Math.abs(changeAmount).toLocaleString('ru-RU');
    anim.style.color = (changeAmount>0?"#2e7d32":"#c62828");
    anim.style.left = balanceDisplay.getBoundingClientRect().left + window.scrollX + "px";
    anim.style.top = balanceDisplay.getBoundingClientRect().top + window.scrollY - 30 + "px";
    document.body.appendChild(anim);
    setTimeout(()=>{
      anim.style.top = (balanceDisplay.getBoundingClientRect().top + window.scrollY - 60) + "px";
      anim.style.opacity = "0";
    },50);
    setTimeout(()=>anim.remove(),1000);
  }
}

/* --- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å --- */
onSnapshot(balanceDocRef,(docSnap)=>{
  if(docSnap.exists()){
    let newBalance = docSnap.data().balance;
    animateBalanceChange(newBalance,lastBalance, newBalance-lastBalance);
    lastBalance = newBalance;
  } else {
    setDoc(balanceDocRef,{balance:lastBalance});
  }
  updateHistory();
});

/* --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é --- */
addBtn.onclick = async ()=>{
  let value = parseFloat(manualAmount.value);
  if(isNaN(value)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!");
  const docSnap = await getDoc(balanceDocRef);
  let currentBalance = docSnap.exists()?docSnap.data().balance:lastBalance;
  currentBalance += value;
  await setDoc(balanceDocRef,{balance:currentBalance});
  await addDoc(changesColRef,{date:new Date().toISOString(),amount:value});
  manualAmount.value = "";
  updateHistory();
}
</script>
